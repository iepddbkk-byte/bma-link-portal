<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Ñ‡πå BMA</title>
    
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,500;1,300&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,400;0,500;1,300&display=swap"></noscript>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --bma-green: #00963C;
            --bma-green-hover: #007a30;
            --button-red: #dc3545;
            --button-red-hover: #c82333;
            --button-blue: #007bff;
            --button-blue-hover: #0056b3;
            --button-yellow: #ffc107;
            --button-yellow-hover: #e0a800;
            --button-gray: #6c757d;
            --light-gray: #f4f4f4;
            --text-color: #333;
        }

        body { 
            font-family: 'Kanit', Arial, sans-serif; 
            margin: 0; 
            padding: 0;
            background-color: var(--light-gray); 
            color: var(--text-color);
        }

        .main-header {
            background-color: #fff;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--bma-green);
            min-height: 80px; 
        }
        .main-header .logo-container { 
            display: flex;
            align-items: center;
        }
        .main-header img {
            height: 70px; 
            margin-right: 15px;
        }

        .container {
            max-width: 1300px;
            margin: 20px auto; 
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        h1 { 
            color: var(--text-color);
            border-bottom: 2px solid var(--light-gray);
            padding-bottom: 10px;
        }

        .search-container {
            margin: 20px 0;
        }
        #searchInput {
            width: 100%;
            padding: 10px;
            font-family: 'Kanit', sans-serif;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            font-size: 0.95em; 
        }
        th, td { 
            padding: 12px; 
            border: 1px solid #ddd; 
            text-align: left; 
            word-break: break-word; 
        }
        th { 
            background-color: var(--bma-green); 
            color: white; 
            text-align: center; 
            vertical-align: middle; 
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏á‡∏Ñ‡πå (3) ‡πÅ‡∏•‡∏∞ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (4) */
        table tbody td:nth-child(3),
        table tbody td:nth-child(4) {
            text-align: center;
        }

        a { 
            color: var(--bma-green); 
            text-decoration: none;
        }
        a:hover { 
            text-decoration: underline; 
        }
        
        button { 
            font-family: 'Kanit', Arial, sans-serif; 
            background-color: var(--bma-green); 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 1em; 
            transition: background-color 0.3s;
            white-space: nowrap; 
        }
        button:hover {
            background-color: var(--bma-green-hover);
        }

        .sort-buttons {
            margin-top: 5px;
        }
        .sort-buttons button {
            font-size: 0.8em; 
            padding: 4px 6px;
            background-color: #fff; 
            color: var(--bma-green);
            border: 1px solid var(--bma-green);
        }
        .sort-buttons button:hover {
            background-color: var(--light-gray);
        }

        .main-header .navigation {
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .main-header .navigation span {
            margin-right: 0; 
            font-size: 1.1em;
            color: var(--text-color); 
        }
        .main-header .btn-dashboard { background-color: var(--bma-green); }
        .main-header .btn-dashboard:hover { background-color: var(--bma-green-hover); }
        .main-header .btn-analytics { background-color: var(--button-blue); }
        .main-header .btn-analytics:hover { background-color: var(--button-blue-hover); }
        .main-header .btn-admin { background-color: var(--button-yellow); color: #212529 !important; }
        .main-header .btn-admin:hover { background-color: var(--button-yellow-hover); }
        .main-header .btn-feedback { background-color: var(--button-gray); }
        .main-header .btn-feedback:hover { background-color: #5a6268; }
        .main-header .btn-logout { background-color: var(--button-red); }
        .main-header .btn-logout:hover { background-color: var(--button-red-hover); }

        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-top: 20px;
            border-top: 1px solid #eee;
        }
        .pagination-items select {
            font-family: 'Kanit', sans-serif;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .pagination-nav button {
            background-color: #6c757d;
            margin: 0 2px;
        }
        .pagination-nav button:hover {
            background-color: #5a6268;
        }
        .pagination-nav button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .pagination-nav span {
            margin: 0 10px;
            font-weight: 500;
        }

        .main-footer {
            background-color: var(--bma-green);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            font-size: 0.9em;
        }
        .main-footer p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    
    <header class="main-header">
        <div class="logo-container">
            <img src="{{ url_for('static', filename='pictures/logo.png') }}" alt="BMA Logo">
            </div>

        <div class="navigation">
            {% if session.get('logged_in') %}
                <span>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, {{ session.name }}!</span>
                
                {% if session.get('level') == 'Admin' %}
                <a href="{{ url_for('admin_panel') }}">
                    <button type="button" class="btn-admin">üëë Admin Panel</button>
                </a>
                {% endif %}
                <a href="{{ url_for('analytics_page') }}">
                    <button type="button" class="btn-analytics">üìä Analytics</button>
                </a>
                <a href="{{ url_for('dashboard') }}">
                    <button type="button" class="btn-dashboard">üñ•Ô∏è Dashboard</button>
                </a>
                <a href="{{ url_for('feedback_page') }}">
                    <button type="button" class="btn-feedback">üìù ‡∏™‡πà‡∏á Feedback</button>
                </a>
                <a href="{{ url_for('logout') }}">
                    <button type="button" class="btn-logout">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </a>
            {% else %}
                <a href="{{ url_for('login_page') }}"><button>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</button></a>
            {% endif %}
        </div>
    </header>
    
    <div class="container">

        <h1>üìã ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏¥‡∏á‡∏Ñ‡πå BMA</h1>
        
        {% if error %}
            <p style="color: red; font-weight: bold;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {{ error }}</p>
        {% endif %}

        <div class="search-container">
            <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó, ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô, ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á)...">
        </div>

        <table>
            <thead>
                <tr>
                    <th>
                        üîó ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Ñ‡πå
                        <div class="sort-buttons">
                            <button onclick="sortTable(0, 'asc')">A-Z (‡∏Å-‡∏Æ)</button>
                            <button onclick="sortTable(0, 'desc')">Z-A (‡∏Æ-‡∏Å)</button>
                        </div>
                    </th>
                    <th>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                    <th>üö¶ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏¥‡∏á‡∏Ñ‡πå</th>
                    <th>üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th>
                    <th>üìÇ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>üè¢ ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                    <th>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</th>
                    
                    <th>üë§ ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                    
                    <th>üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
                </tr>
            </thead>
            <tbody id="linkTableBody">
                
                {% for link in links %}
                <tr>
                    <td>
                        <a href="{{ link.URL }}" target="_blank">{{ link.‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå }}</a>
                    </td>
                    <td>{{ link.‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ }}</td>
                    
                    <td>
                        {% if link.LinkStatus == 'OK' %}
                            <span style="color: green; font-weight: 500;">üü¢ ‡∏õ‡∏Å‡∏ï‡∏¥</span>
                        {% elif link.LinkStatus == '403 Blocked' %}
                            <span style="color: #007bff; font-weight: 500;">üîµ ‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å</span>
                        {% elif link.LinkStatus %}
                            <span style="color: red; font-weight: 500;">üî¥ {{ link.LinkStatus }}</span>
                        {% else %}
                            <span style="color: gray;">‚ö™ (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</span>
                        {% endif %}
                    </td>

                    <td>
                        {% if link.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ == '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' %}
                            <span style="color: green;">‚óè ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                        {% elif link.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ == '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á' %}
                            <span style="color: #FFC107;">‚óè ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</span>
                        {% elif link.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ == '‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' %}
                            <span style="color: red;">‚óè ‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                        {% else %}
                            {{ link.‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ }}
                        {% endif %}
                    </td>
                    <td>{{ link.‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó }}</td>
                    <td>{{ link.‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô }}</td>
                    <td>{{ link.‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ }}</td>
                    
                    <td>
                        <a href="{{ url_for('view_profile', username=link.CreatorUsername) }}" target="_blank" style="font-weight: 500;">
                            {{ link.CreatorUsername }}
                        </a>
                    </td>

                    <td>{{ link.‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï.split(' ')[0] }}</td>
                </tr>
                {% else %}
                <tr id="noDataRow">
                    <td colspan="9" style="text-align: center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏¥‡∏á‡∏Ñ‡πå</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="pagination-controls">
            <div class="pagination-items">
                <span>‡πÅ‡∏™‡∏î‡∏á: </span>
                <select id="itemsPerPage">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="99999">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
                <span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="pagination-nav">
                <button id="btnFirst"> << </button>
                <button id="btnPrev"> < </button>
                <span> ‡∏´‡∏ô‡πâ‡∏≤ <span id="currentPage">1</span> / <span id="totalPages">1</span> </span>
                <button id="btnNext"> > </button>
                <button id="btnLast"> >> </button>
            </div>
        </div>

    </div> 
    
    <footer class="main-footer">
        <p>‡∏Å‡∏≠‡∏á‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•</p>
        <p>‡πÇ‡∏ó‡∏£ 0-2221-2141-69 ‡∏ï‡πà‡∏≠ 1513</p>
    </footer>

    <script>
        let allTableRows = []; 
        let currentPage = 1;
        let totalPages = 1;
        const tbody = document.getElementById("linkTableBody");
        const noDataRow = document.getElementById("noDataRow");
        let searchInput; 

        function sortTable(columnIndex, direction) {
            const collator = new Intl.Collator('th', { sensitivity: 'base' });
            allTableRows.sort((rowA, rowB) => {
                const cellA = rowA.getElementsByTagName("td")[columnIndex].querySelector('a') 
                              ? rowA.getElementsByTagName("td")[columnIndex].querySelector('a').textContent.trim() 
                              : rowA.getElementsByTagName("td")[columnIndex].textContent.trim();
                const cellB = rowB.getElementsByTagName("td")[columnIndex].querySelector('a')
                              ? rowB.getElementsByTagName("td")[columnIndex].querySelector('a').textContent.trim()
                              : rowB.getElementsByTagName("td")[columnIndex].textContent.trim();
                if (direction === 'asc') {
                    return collator.compare(cellA, cellB);
                } else {
                    return collator.compare(cellB, cellA);
                }
            });
            displayPage(currentPage);
        }
        function displayPage(page) {
            currentPage = page;
            const itemsPerPage = parseInt(document.getElementById("itemsPerPage").value);
            const filter = searchInput.value.toLowerCase(); 
            const filteredRows = allTableRows.filter(row => {
                const cells = row.getElementsByTagName("td");
                const name = (cells[0].textContent || cells[0].innerText).toLowerCase();
                const status = (cells[3].textContent || cells[3].innerText).toLowerCase();
                const type = (cells[4].textContent || cells[4].innerText).toLowerCase();
                const department = (cells[5].textContent || cells[5].innerText).toLowerCase();
                // (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç!) ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á (index 7) ‡πÅ‡∏ó‡∏ô email ‡πÄ‡∏î‡∏¥‡∏°
                const creator = (cells[7].textContent || cells[7].innerText).toLowerCase();
                
                const combinedText = name + " " + status + " " + type + " " + department + " " + creator;
                return combinedText.includes(filter);
            });
            tbody.innerHTML = ''; 
            if (filteredRows.length === 0) {
                if(noDataRow) tbody.appendChild(noDataRow);
                totalPages = 1;
                currentPage = 1;
            } else {
                totalPages = Math.ceil(filteredRows.length / itemsPerPage);
                if (page > totalPages) currentPage = totalPages;
                if (page < 1) currentPage = 1;
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const slicedRows = filteredRows.slice(startIndex, endIndex);
                slicedRows.forEach(row => {
                    tbody.appendChild(row);
                });
            }
            document.getElementById("currentPage").textContent = currentPage;
            document.getElementById("totalPages").textContent = totalPages;
            document.getElementById("btnFirst").disabled = (currentPage === 1);
            document.getElementById("btnPrev").disabled = (currentPage === 1);
            document.getElementById("btnNext").disabled = (currentPage === totalPages);
            document.getElementById("btnLast").disabled = (currentPage === totalPages);
        }
        document.addEventListener('DOMContentLoaded', () => {
            allTableRows = Array.from(tbody.children).filter(row => row.id !== 'noDataRow');
            searchInput = document.getElementById("searchInput"); 
            document.getElementById("btnFirst").addEventListener('click', () => displayPage(1));
            document.getElementById("btnPrev").addEventListener('click', () => displayPage(currentPage - 1));
            document.getElementById("btnNext").addEventListener('click', () => displayPage(currentPage + 1));
            document.getElementById("btnLast").addEventListener('click', () => displayPage(totalPages));
            document.getElementById("itemsPerPage").addEventListener('change', () => displayPage(1)); 
            searchInput.addEventListener('keyup', () => displayPage(1)); 
            displayPage(1);
        });
    </script>
    <script>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                const messages = {{ messages | tojson }};
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true,
                });
                messages.forEach(([category, message]) => {
                    Toast.fire({
                        icon: category,
                        title: message
                    });
                });
            {% endif %}
        {% endwith %}
    </script>
</body>
</html>